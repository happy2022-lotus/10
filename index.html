<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>디지털 리터러시 공유 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정 및 초기화
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        setLogLevel('debug'); // 디버깅을 위해 로그 레벨 설정

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;

        // 앱의 질문 목록 정의
        const sections = [
            {
                title: "1. 디지털 도구 활용",
                questions: [
                    { id: "q1", text: "어떤 에듀테크 도구들을 주로 활용하시나요?" },
                    { id: "q2", text: "온라인 수업 자료의 출처는 어떻게 표기하시나요?" }
                ]
            },
            {
                title: "2. 정보와 보안",
                questions: [
                    { id: "q3", text: "계정의 비밀번호를 안전하게 관리하는 나만의 팁이 있으신가요?" }
                ]
            },
            {
                title: "3. 콘텐츠 제작",
                questions: [
                    { id: "q4", text: "영상 편집을 직접 해보셨다면, 어떤 프로그램을 추천하시나요?" }
                ]
            },
            {
                title: "4. AI 활용",
                questions: [
                    { id: "q5", text: "AI 도구를 수업 준비에 활용해 보셨다면, 어떤 점이 가장 유용했나요?" }
                ]
            },
            {
                title: "5. 디지털 시민성",
                questions: [
                    { id: "q6", text: "학생들에게 온라인 예절을 가르치는 나만의 노하우는 무엇인가요?" }
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            const appContainer = document.getElementById('app');
            // 사용자 인증 상태가 준비되면 UI를 렌더링하고 리스너를 설정합니다.
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("인증 완료. 사용자 ID:", userId);
                    renderUI(appContainer);
                    setupRealtimeListeners();
                } else {
                    try {
                        // 초기 인증 토큰이 있으면 사용하고, 없으면 익명으로 로그인합니다.
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("인증 오류:", error);
                        document.getElementById('app').innerHTML = '<div class="text-center text-red-500 mt-20">인증에 실패했습니다. 페이지를 새로고침 해주세요.</div>';
                    }
                }
            });
        });

        // UI를 화면에 그리는 함수
        function renderUI(container) {
            let htmlContent = `<div id="loading" class="text-center text-lg text-gray-500 mt-20">잠시만 기다려주세요...</div>`;
            htmlContent += `<div id="content" class="hidden container mx-auto p-4 md:p-8 space-y-8 max-w-2xl bg-white rounded-xl shadow-lg mt-8">`;
            htmlContent += `<h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800">디지털 리터러시 공유 앱</h1>`;
            htmlContent += `<div class="text-center text-sm text-gray-500 mt-2">이 앱은 선생님들의 답변을 실시간으로 공유합니다.<br>새로운 답변이 올라오면 자동으로 업데이트됩니다.</div>`;
            // 사용자 ID를 표시하는 부분은 인증 후에 업데이트됩니다.
            htmlContent += `<div class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-md text-sm text-center mb-4"><span class="font-bold">내 사용자 ID:</span> ${userId}</div>`;
            
            sections.forEach(section => {
                htmlContent += `<div class="p-6 bg-gray-50 rounded-lg shadow-inner">`;
                htmlContent += `<h2 class="text-xl md:text-2xl font-semibold text-blue-600 mb-4">${section.title}</h2>`;
                section.questions.forEach(q => {
                    htmlContent += `<div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white">`;
                    htmlContent += `<label for="${q.id}" class="block text-lg font-medium text-gray-700 mb-2">${q.text}</label>`;
                    htmlContent += `<textarea id="${q.id}" class="answer-input w-full p-3 border-2 border-gray-300 rounded-md focus:outline-none focus:border-blue-500 transition duration-200" rows="3" placeholder="답변을 입력해주세요..."></textarea>`;
                    htmlContent += `<button id="submit-${q.id}" class="submit-btn mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">답변 제출하기</button>`;
                    htmlContent += `<div id="answers-${q.id}" class="mt-4 space-y-3"></div>`;
                    htmlContent += `</div>`;
                });
                htmlContent += `</div>`;
            });
            htmlContent += `</div>`;
            container.innerHTML = htmlContent;
        }

        // Firestore 실시간 리스너 및 이벤트 핸들러 설정
        async function setupRealtimeListeners() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            loading.classList.add('hidden');
            content.classList.remove('hidden');

            // 사용자 ID 업데이트
            const userIdDisplay = document.querySelector('.bg-yellow-100');
            if (userIdDisplay) {
                userIdDisplay.innerHTML = `<span class="font-bold">내 사용자 ID:</span> ${userId}`;
            }

            // 제출 버튼에 이벤트 리스너 부착
            document.querySelectorAll('.submit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const questionId = event.target.id.replace('submit-', '');
                    saveAnswer(questionId);
                });
            });

            // 각 질문에 대한 실시간 답변 업데이트
            const answersRef = collection(db, `artifacts/${appId}/public/data/answers`);
            onSnapshot(answersRef, (snapshot) => {
                const allAnswers = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docUserId = doc.id;
                    sections.forEach(section => {
                        section.questions.forEach(q => {
                            if (data[q.id]) {
                                if (!allAnswers[q.id]) {
                                    allAnswers[q.id] = [];
                                }
                                allAnswers[q.id].push({ userId: docUserId, answer: data[q.id] });
                            }
                        });
                    });
                });

                // 모든 질문에 대한 답변을 한 번에 업데이트
                sections.forEach(section => {
                    section.questions.forEach(q => {
                        displayAnswers(q.id, allAnswers[q.id] || []);
                    });
                });
            });
        }

        // 답변을 Firestore에 저장하는 함수
        async function saveAnswer(questionId) {
            if (!isAuthReady) {
                console.log("인증이 준비되지 않았습니다. 저장할 수 없습니다.");
                return;
            }

            const answer = document.getElementById(questionId).value.trim();
            if (!answer) {
                console.log("답변 내용이 비어 있습니다.");
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/answers/${userId}`);

            try {
                await setDoc(docRef, { [questionId]: answer, timestamp: new Date() }, { merge: true });
                console.log("답변이 성공적으로 저장되었습니다!");
                // 답변 입력창을 비웁니다.
                document.getElementById(questionId).value = '';
            } catch (error) {
                console.error("답변 저장 중 오류 발생:", error);
            }
        }

        // UI에 답변을 표시하는 함수
        function displayAnswers(questionId, answers) {
            const answersDiv = document.getElementById(`answers-${questionId}`);
            if (!answersDiv) return;

            answersDiv.innerHTML = ''; // 기존 답변들을 초기화

            if (answers.length === 0) {
                answersDiv.innerHTML = '<p class="text-sm text-gray-400">아직 답변이 없습니다. 첫 답변을 남겨주세요!</p>';
                return;
            }

            // 최신 답변이 위로 오도록 정렬
            const sortedAnswers = answers.sort((a, b) => b.timestamp - a.timestamp);

            sortedAnswers.forEach(item => {
                const answerElement = document.createElement('div');
                answerElement.className = 'p-3 bg-gray-100 rounded-md';
                answerElement.innerHTML = `
                    <p class="text-sm text-gray-500 font-bold mb-1">사용자 ID: ${item.userId}</p>
                    <p class="text-gray-800">${item.answer}</p>
                `;
                answersDiv.appendChild(answerElement);
            });
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app" class="w-full">
        <div class="text-center text-lg text-gray-500 mt-20">앱을 불러오는 중입니다...</div>
    </div>
</body>
</html>
